#' plot_scatterplot UI Function
#'
#' @description A shiny Module.
#'
#' @param id,input,output,session Internal parameters for {shiny}.
#'
#' @noRd
#'
#' @importFrom shiny NS tagList selectInput
#' @importFrom shinycssloaders withSpinner
mod_scatterplot_ui <- function(id){
  ns <- NS(id)
  tagList(
         uiOutput(ns("title_scatterplot")),
         selectInput(inputId = ns("growth_factor"), label = "Select growth factor",
                          choices = list("Over 3 days" = "growth_factor_3",
                                         "Over one week" = "growth_factor_7",
                                         "Over 2 weeks" = "growth_factor_14"),
                          selected = "growth_factor_7"),
         withSpinner(uiOutput(ns("plot_scatterplot"))),
      )
}
#' Scatterplot prevalence vs growth
#'
#' @param df data.frame for multiple countries
#' @param nmed number of cases of countries to be used for median computation
#' @param wmed days of outbreak of countries to be used for median computation
#' @param n_highligth number of countries to highlight if istop == TRUE
#' @param istop logical to choose title, if top n_highligth countries are selected
#' @param countries countries selected
#'
#' @note if there are no countries with confirmed cases > nmed then all are taken to compute medians
#'
#' @import dplyr
#' @import tidyr
#' @import ggplot2
#' @importFrom plotly ggplotly layout plotly_build
#'
#' @noRd
mod_scatterplot_server <- function(input, output, session, df, nmed = 10000, wmed = 7, n_highligth = 5, istop = TRUE, countries){
  ns <- session$ns
  # titles
  if (istop) {
    output$title_scatterplot <- renderUI(div(h4(paste0("Current top ", n_highligth, " Growth vs Prevalence")), align = "center", style = "margin-top:20px; margin-bottom:20px;"))
  } else {
    output$title_scatterplot <- renderUI(div(h4("Growth vs Prevalence"), align = "center", style = "margin-top:20px; margin-bottom:20px;"))
  }
  # select growth factor
  addgrowth = function(df, grate) {
    df$growthfact = df[[grate]]
    df = df[, !(grepl("^growth_factor", names(df)))]
    df
  }

  #world = function(dat, n, w){
  world = function(dat){
    dat %>% #TODO select_countries_n_cases_w_days can be removed if data_filtered is the input
      #select_countries_n_cases_w_days(n = n, w = w) %>%
      filter( date == max(date)) %>%
      select(Country.Region,date,confirmed,starts_with("growth"),confirmed_rate_1M_pop)
  }
  pick_rate <- function(df, rate){
    df <-  df  %>%
      bind_cols(df[, rate] %>% setNames("Value"))
    df
  }

  # prepare data select those with more than 10000
  #world_data = world(df, n,w)
  world_data = world(df)

  confirmed1000 =  any(world_data$confirmed > nmed)
  world_10000 =
    if (confirmed1000)
      world_data %>% filter(confirmed > nmed)
    else
      world_data

  # compute stats for all growth factors
  med_growth = reactive({apply(world_10000[, grepl("growth", names(world_10000)), drop = FALSE],2, median, na.rm = TRUE)})
  med_prevalence = reactive({median(world_10000$confirmed_rate_1M_pop, na.rm = TRUE)})

  medgr = reactive({med_growth()[req(input$growth_factor)]})

  df_top = reactive({pick_rate(world_data, "confirmed") %>%
      arrange(desc(Value)) })

  if (istop)  { # choose top n_highligth
    df_top_new = reactive({df_top() %>%
      top_n(n_highligth, wt = Value) %>% .[1:n_highligth,]})
  } else {
    df_top_new = reactive({df_top() %>%
        filter(Country.Region %in% countries)})
  }

  dfnew = reactive({addgrowth(df_top_new(),req(input$growth_factor))})

  #caption_growth_factor <- reactive({paste0("(y) growth factor: total confirmed cases today / total confirmed cases ", gsub("growth_factor_", "", req(input$growth_factor)) ," days ago.")})
  #caption_growth_factor <- reactive({paste0("(y) Growth Factor: total confirmed cases since ", gsub("growth_factor_", "", req(input$growth_factor)) ," days ago. / total confirmed cases in previous 30 days")})
  caption_growth_factor <- reactive({paste("(y)" , caption_growth_factor_fun(req(input$growth_factor)))})

  caption_prevalence <- "(x) Prevalence: confirmed cases over 1 M people."
  caption_median <- paste("Dotted lines show median values",
          ifelse(confirmed1000, paste0("among countries with more than ", nmed," cases."), ""))

  output$plot_scatterplot <- renderUI({
    tagList(
      plotlyOutput(ns("plot_scatterplot_xy"), height = 400),
      div(p(caption_growth_factor()), align = "center"),
      div(p(caption_prevalence), align = "center"),
      div(p(caption_median), align = "center"),
    )
  })

  output$plot_scatterplot_xy <- renderPlotly({

    df_plot <- dfnew() %>%
      mutate(Country.Region = as.factor(Country.Region))
    p = df_plot %>%
        scatter_plot(list(x = med_prevalence(),
                          y = medgr()))
    p <- p %>%
      #ggplotly(tooltip = c("text", "y"))# %>%
      ggplotly(tooltip = c("text"))# %>%

      # layout(legend = list(orientation = "h",
      #                      #y = 1.1,
      #                      yanchor = "bottom"))

    p <- plotly_build(p)

    length<-length(p$x$data)
    invisible(lapply(1:length, function(x) p$x$data[[x]]<<-c(p$x$data[[x]], textposition ='top center')))

    p
  })
}
