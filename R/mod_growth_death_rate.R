#' growth_death_rate UI Function
#'
#' @description A shiny Module.
#'
#' @param id,input,output,session Internal parameters for {shiny}.
#'
#' @noRd
#'
#' @importFrom shiny NS tagList
#' @importFrom shinycssloaders withSpinner
mod_growth_death_rate_ui <- function(id){
  ns <- NS(id)

  tagList(
    fluidRow(
      column(6,
             uiOutput(ns("title_growth_factor")),
             selectInput(inputId = ns("growth_factor"), label = "",
                          choices = list("Over 3 days" = "growth_factor_3",
                                        # "Over 5 days" = "growth_factor_5",
                                         "Over one week" = "growth_factor_7",
                                          "Over 2 weeks" = "growth_factor_14")
                         ,
                          selected = "growth_factor_7"),
             withSpinner(uiOutput(ns("plot_growth_factor")))
      ),
      column(6,
             uiOutput(ns("title_death_toll")),
             selectInput(inputId = ns("radio_pop"), label = "",
                          choices = varsNames(c("lethality_rate","deaths_rate_1M_pop")),
                          selected = "lethality_rate"),
             withSpinner(uiOutput(ns("plot_death_rate")))
      )
    )
  )
}

#' growth_death_rate Server Function
#'
#' @param df reactive data.frame
#' @param nn min number of cases for a country to be considered. Default 1000
#' @param w number of days of outbreak. Default 7
#' @param n_highligth number of countries to highlight
#' @param istop logical to choose title
#' @param g_palette list of character vector of colors for the graph and legend of growth_factor and death_rate
#'
#' @import dplyr
#' @import tidyr
#'
#' @example ex-mod_growth_death_rate.R
#'
#' @noRd
mod_growth_death_rate_server <- function(input, output, session, df, nn = 1000, w = 7,
                                         n_highligth = 5, istop = TRUE,
                                         g_palette = list("growth_factor" = rate_colors["growth_factor"],
                                                        "death_rate" = rate_colors["death_rate"])){
  ns <- session$ns

  # Help funcs ----

  scale_mortality_rate <- function(dat){
    df1 <- dat %>%
      select_countries_n_cases_w_days(n = nn, w = 0) %>% # changed to w = 0 since we have only last day
      filter( date == max(date))
    df1
  }

  pick_rate <- function(df, rate){
    df <-  df  %>%
      bind_cols(df[, rate] %>% setNames("Value"))
    df
  }

  pick_rate_hist <- function(df1, rate) {
    df_plot <- df1 %>%
      pick_rate(rate) %>%
      arrange(desc(Value)) %>%
      top_n(n_highligth, wt = Value) %>%
      mutate(Country = factor(Country.Region, levels = .$Country.Region)) %>%
      select(Country, Value)

    df_plot
  }

  # Dataset ----
  df_pop <- reactive(scale_mortality_rate(df))

  df_base_plot1 <- reactive({pick_rate_hist( df_pop(), req(input$growth_factor))})
  df_base_plot2 <- reactive({pick_rate_hist( df_pop(), req(input$radio_pop))})

  # Plots ----
  # titles
  if (istop) {
    output$title_growth_factor <- renderUI(div(h4(paste0("Current top ", n_highligth, " countries growth factor")), align = "center", style = "margin-top:20px; margin-bottom:20px;"))
    output$title_death_toll <- renderUI(div(h4(paste0("Current top ", n_highligth, " countries death toll")), align = "center", style = "margin-top:20px; margin-bottom:20px;"))
  } else {
    output$title_growth_factor <- renderUI(div(h4("Growth factor"), align = "center", style = "margin-top:20px; margin-bottom:20px;"))
    output$title_death_toll <- renderUI(div(h4("Death toll"), align = "center", style = "margin-top:20px; margin-bottom:20px;"))
  }

  # captions
  #caption_growth_factor <- reactive({paste0("Computed as total confirmed cases today / total confirmed cases ", gsub("growth_factor_", "", req(input$growth_factor)) ," days ago.")})
  #caption_growth_factor <- reactive({paste0("Total confirmed cases since ", gsub("growth_factor_", "", req(input$growth_factor)) ," days ago. / total confirmed cases in previous 30 days")})
  caption_growth_factor <- reactive({ caption_growth_factor_fun(req(input$growth_factor))})
  caption_death_rate_radio <- reactive({
    if (req(input$radio_pop) == "lethality_rate") {
      p <- "/ total confirmed cases today."
    } else {
      p <- "per 1 M population "
    }
    p
  })
  caption_death_rate <- reactive({paste0("Computed as total deaths today ",caption_death_rate_radio())})
  #caption_countries <- paste0("More than ", n, " confirmed cases and outbreaks longer than ", w, " days.")

  # plots
  output$plot_growth_factor <- renderUI({
    tagList(
      plotlyOutput(ns("plot_growth_factor_hist"), height = 400),
      div(p(caption_growth_factor()), align = "center")#,
      #div(p(caption_countries), align = "center"),
    )
  })

  output$plot_death_rate <- renderUI({
    tagList(
      plotlyOutput(ns("plot_death_rate_hist"), height = 400),
      div(p(caption_death_rate()), align = "center")#,
      #div(p(caption_countries), align = "center"),
    )
  })

  output$plot_growth_factor_hist <- renderPlotly({
    g_palette_gf = g_palette[["growth_factor"]]
    p <- plot_rate_hist(df_base_plot1(), y_min = 1,
                        #percent = is_percent(),
                        g_palette =  g_palette_gf)
    p <- p %>%
      plotly::ggplotly() %>%
      plotly::layout(legend = list(orientation = "h", y = 1.1, yanchor = "bottom")
                      #             xaxis = list(tickfont = list(size = 10))
                     )
    p
  })

  is_percent <- reactive({ifelse(req(input$radio_pop) == "lethality_rate", TRUE, FALSE)})
  output$plot_death_rate_hist <- renderPlotly({
    message("is_percent = ", is_percent())

    g_palette_drf = g_palette[["death_rate"]]

    p <- plot_rate_hist(df_base_plot2(), percent = is_percent(), g_palette =  g_palette_drf)
    p <- p %>%
      plotly::ggplotly() %>%
      plotly::layout(legend = list(orientation = "h", y = 1.1, yanchor = "bottom")
                     #xaxis = list(tickfont = list(size = 10))
                     )
    p
  })

}
